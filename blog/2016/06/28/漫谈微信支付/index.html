<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>漫谈微信支付 | Yuri&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="漫谈微信支付">
<meta property="og:type" content="article">
<meta property="og:title" content="漫谈微信支付">
<meta property="og:url" content="http://yurixu.com/blog/2016/06/28/漫谈微信支付/index.html">
<meta property="og:site_name" content="Yuri's Blog">
<meta property="og:description" content="漫谈微信支付">
<meta property="og:image" content="http://7xrc03.com1.z0.glb.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpeg">
<meta property="og:image" content="http://7xrc03.com1.z0.glb.clouddn.com/%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87.png">
<meta property="og:updated_time" content="2018-05-22T02:15:12.171Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="漫谈微信支付">
<meta name="twitter:description" content="漫谈微信支付">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <!--link href="//fonts.useso.com/css?family=Lato:400,400italic" rel="stylesheet" type="text/css"-->
  <link href="http://yurixu.com/css/fonts/Google/font.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">  
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3da38d5511434722ab5f79d1cffab2ad";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



  <!--

-->
  

  <!-- add by yurixu 2016/1/13 向百度提交sitemap-->
  <meta name="baidu-site-verification" content="ubBCJmBrxD" />
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Yuri&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Walk step by step</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories/Read/">Reading</a>
        
          <a class="main-nav-link" href="https://github.com/xuyuri">GitHub</a>
        
          <a class="main-nav-link" href="/atom.xml">RSS</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <! --modify by yurixu 22016/1/8 修改search为swiftype -->
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        <!-- <input type="text" class="st-default-search-input"> -->
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yurixu.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-漫谈微信支付" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      漫谈微信支付
    </h1>
  

      </header>
    
    <!-- add by yurixu 2016/1/3 将文章时间放在标题下 -->
    <div class="article-meta">
      <a href="/blog/2016/06/28/漫谈微信支付/" class="article-date">
  <time datetime="2016-06-28T14:54:15.000Z" itemprop="datePublished">2016-6-28 周二  22:54</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <!-- add by yurixu 2016/1/3 添加文章目录 -->
        
        <p><img src="http://7xrc03.com1.z0.glb.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpeg" alt=""><br>本文对微信支付的应用场景、支付模式、准备工作、官方SDK等进行简要介绍。<br><a id="more"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>微信支付目前在生活中应用的越来越广泛，目前微信支付的应用模式有刷卡支付、公共号支付、扫码支付以及APP支付，每种支付模式都有不同的应用场景与之对应。</p>
<h2 id="支付模式"><a href="#支付模式" class="headerlink" title="支付模式"></a>支付模式</h2><h3 id="刷卡支付"><a href="#刷卡支付" class="headerlink" title="刷卡支付"></a>刷卡支付</h3><p>刷卡支付是用户展示微信钱包内的“刷卡条码/二维码”给商户系统扫描后直接完成支付的模式。主要应用线下面对面收银的场景。</p>
<h3 id="扫码支付"><a href="#扫码支付" class="headerlink" title="扫码支付"></a>扫码支付</h3><p>扫码支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。</p>
<h3 id="公共号支付"><a href="#公共号支付" class="headerlink" title="公共号支付"></a>公共号支付</h3><p>公众号支付是用户在微信中打开商户的H5页面，商户在H5页面通过调用微信支付提供的JSAPI接口调起微信支付模块完成支付。应用场景有：<br>◆ 用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付<br>◆ 用户的好友在朋友圈、聊天窗口等分享商家页面连接，用户点击链接打开商家页面，完成支付<br>◆ 将商户页面转换成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付。</p>
<h3 id="APP支付"><a href="#APP支付" class="headerlink" title="APP支付"></a>APP支付</h3><p>APP支付又称移动端支付，是商户通过在移动端应用APP中集成开放SDK调起微信支付模块完成支付的模式。</p>
<p>本系列文章主要介绍后三种支付模式，分别介绍三种不同支付模式的实现以及汇总实现过程中可能遇到问题。</p>
<hr>
<h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><p>使用微信支付前需要进行微信支付接入，商户根据实际需求可以申请接入以上介绍的四种不同支付模式，其中APP支付模式需要首先在<a href="https://open.weixin.qq.com/" target="_blank" rel="external">微信开放平台</a>注册成为开发者，创建APP后才能继续申请，申请步骤可以参考<a href="http://kf.qq.com/faq/120911VrYVrA150906F3qqY3.html" target="_blank" rel="external">APP微信商户申请步骤</a>；<br>扫码支付和公共号支付需要先在<a href="http://mp.weixin.qq.com" target="_blank" rel="external">微信公共平台</a>注册公共号并进行认证，然后再继续申请微信支付，申请步骤可以参考<a href="http://kf.qq.com/faq/120911VrYVrA150905zeYjMZ.html" target="_blank" rel="external">公众平台微信支付商户申请步骤</a>。申请成功后，微信支付开发相关的账号信息会被发送至申请邮箱中，包括：<br><img src="http://7xrc03.com1.z0.glb.clouddn.com/%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87.png" alt="前期准备"></p>
<table>
<thead>
<tr>
<th style="text-align:left">邮件中参数</th>
<th style="text-align:left">API参数名</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">APPID</td>
<td style="text-align:left">appid</td>
<td style="text-align:left">微信公众账号或开放平台APP的唯一标识</td>
</tr>
<tr>
<td style="text-align:left">商户号</td>
<td style="text-align:left">mch_id</td>
<td style="text-align:left">微信支付分配的商户收款账号</td>
</tr>
<tr>
<td style="text-align:left">API密钥</td>
<td style="text-align:left">key</td>
<td style="text-align:left">交易过程生成签名的密钥，仅保留在商户系统和微信支付后台，不会在网络中传播</td>
</tr>
<tr>
<td style="text-align:left">Appsecret</td>
<td style="text-align:left">secret</td>
<td style="text-align:left">APPID对应的接口密码，用于获取接口调用凭证access_token时使用</td>
</tr>
</tbody>
</table>
<p>得到这些参数后就可以进行微信支付的开发了。</p>
<hr>
<h2 id="微信支付PHP-SDK"><a href="#微信支付PHP-SDK" class="headerlink" title="微信支付PHP-SDK"></a>微信支付PHP-SDK</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>微信提供了JAVA、.NET/C#、PHP三种类型的SDK，PHP版本的SDK目录结构如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SDK&#30446;&#24405;&#32467;&#26500;&#10;|-- cert&#10;|   |-- apiclient_cert.pem&#10;|   |-- apiclient_key.pem&#10;|-- index.php&#10;|-- lib&#10;|   |-- WxPay.Api.php&#10;|   |-- WxPay.Config.php&#10;|   |-- WxPay.Data.php&#10;|   |-- WxPay.Exception.php&#10;|   |-- WxPay.Notify.php&#10;|-- logs&#10;|-- example&#10;    |-- WxPay.JsApiPay.php&#10;    |-- WxPay.MicroPay.php&#10;    |-- WxPay.NativePay.php&#10;&#9;|-- download.php&#10;&#9;|-- micropay.php&#10;&#9;|-- native.php&#10;&#9;|-- native_notify.php&#10;&#9;|-- notify.php&#10;&#9;|-- orderquery.php&#10;&#9;|-- qrcode.php&#10;&#9;|-- refund.php&#10;&#9;|-- refundquery.php&#10;&#9;|-- jsapi.php&#10;    |-- log.php&#10;    |-- phpqrcode</span><br></pre></td></tr></table></figure></p>
<p>各个目录以及文件的说明如下：<br>◆ <strong>cert：证书的存放路径</strong><br>商户证书是微信提供的二进制文件，商户系统发起与微信支付后台服务器通信请求的时候，作为微信支付后台识别商户真实身份的凭据。<br><strong>商户证书在涉及资金回滚的微信支付接口中使用，包括：申请退款、撤销订单接口。在使用的过程中服务器要做好病毒和木马的防护措施，防止证书被窃取</strong>。<br>微信提供了四种商户证书：pkcs12格式、证书pem格式、证书密钥pem格式、CA证书，登录<a href="pay.weixin.qq.com">微信商户平台</a>–&gt;账户设置–&gt;API安全–&gt;证书下载，可以进行证书下载。PHP开发只需要用到证书pem格式、证书密钥pem格式，即apiclient_cert.pem和apiclient_key.pem。<br>◆ <strong>index.php：SDK的入口文件</strong><br>◆ <strong>lib：微信支付API库</strong><br>lib目录下的文件是微信支付开发用到的主要文件，提供了对微信支付的各种接口的封装。其中：<br><code>WxPay.Config.php</code>：封装了WxPayConfig类，提供了微信支付所需的基本配置信息包括：APPID、MCHID、KEY、APPSECRET、证书路径、代理设置、微信支付接口上报配置。<br><code>WxPay.Data.php</code>：接口输入参数的封装，包括：WxPayDataBase（数据对象基础类）、WxPayResults（接口调用结果类）、WxPayNotifyReply（微信支付回调基础类）、WxPayUnifiedOrder（微信支付统一下单类）、WxPayOrderQuery（查询订单类）、WxPayCloseOrder（关闭订单类）、WxPayRefund（申请退款类）、WxPayRefundQuery（查询退款类）、WxPayDownloadBill（下载对账单类）、WxPayReport（接口测试上报类）、WxPayShortUrl（短连接转换类）、WxPayMicroPay（刷卡支付类）、WxPayReverse（撤销订单类）、WxPayJsApiPay（公共号支付类）以及WxPayBizPayUrl（扫码支付模式一）<br>◆ <strong>logs：日志文件</strong><br>◆ <strong>example：样例程序</strong></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="WxPayDataBase类"><a href="#WxPayDataBase类" class="headerlink" title="WxPayDataBase类"></a>WxPayDataBase类</h4><p><em><font color="green">位置：lib/WxPay.Data.php</font></em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * </span><br><span class="line"> * 数据对象基础类，该类中定义数据类最基本的行为，包括：</span><br><span class="line"> * 计算/设置/获取签名、输出xml格式的参数、从xml读取数据对象等</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WxPayDataBase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$values</span> = <span class="keyword">array</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">  * 设置签名，详见签名生成算法</span><br><span class="line">  * <span class="doctag">@param</span> string $value </span><br><span class="line">  **/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">SetSign</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$sign</span> = <span class="variable">$this</span>-&gt;MakeSign();</span><br><span class="line">    <span class="variable">$this</span>-&gt;values[<span class="string">'sign'</span>] = <span class="variable">$sign</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$sign</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">  * 获取签名，详见签名生成算法的值</span><br><span class="line">  * <span class="doctag">@return</span> 值</span><br><span class="line">  **/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">GetSign</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;values[<span class="string">'sign'</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">  * 判断签名，详见签名生成算法是否存在</span><br><span class="line">  * <span class="doctag">@return</span> true 或 false</span><br><span class="line">  **/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">IsSignSet</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array_key_exists(<span class="string">'sign'</span>, <span class="variable">$this</span>-&gt;values);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * 输出xml字符</span><br><span class="line">   * <span class="doctag">@throws</span> WxPayException</span><br><span class="line">  **/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ToXml</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!is_array(<span class="variable">$this</span>-&gt;values) </span><br><span class="line">      || count(<span class="variable">$this</span>-&gt;values) &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    		<span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"数组数据异常！"</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    	</span><br><span class="line">    	<span class="variable">$xml</span> = <span class="string">"&lt;xml&gt;"</span>;</span><br><span class="line">    	<span class="keyword">foreach</span> (<span class="variable">$this</span>-&gt;values <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)</span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="keyword">if</span> (is_numeric(<span class="variable">$val</span>))&#123;</span><br><span class="line">    			<span class="variable">$xml</span>.=<span class="string">"&lt;"</span>.<span class="variable">$key</span>.<span class="string">"&gt;"</span>.<span class="variable">$val</span>.<span class="string">"&lt;/"</span>.<span class="variable">$key</span>.<span class="string">"&gt;"</span>;</span><br><span class="line">    		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    			<span class="comment">//CDATA 部分中的所有内容都会被解析器忽略。</span></span><br><span class="line">    			<span class="variable">$xml</span>.=<span class="string">"&lt;"</span>.<span class="variable">$key</span>.<span class="string">"&gt;&lt;![CDATA["</span>.<span class="variable">$val</span>.<span class="string">"]]&gt;&lt;/"</span>.<span class="variable">$key</span>.<span class="string">"&gt;"</span>;</span><br><span class="line">    		&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$xml</span>.=<span class="string">"&lt;/xml&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$xml</span>; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 将xml转为array</span><br><span class="line">     * <span class="doctag">@param</span> string $xml</span><br><span class="line">     * <span class="doctag">@throws</span> WxPayException</span><br><span class="line">     */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">FromXml</span><span class="params">(<span class="variable">$xml</span>)</span></span><br><span class="line">  </span>&#123;	</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$xml</span>)&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"xml数据异常！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">//将XML转为array</span></span><br><span class="line">        <span class="comment">//禁止引用外部xml实体</span></span><br><span class="line">        libxml_disable_entity_loader(<span class="keyword">true</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;values = json_decode(json_encode(simplexml_load_string(<span class="variable">$xml</span>, <span class="string">'SimpleXMLElement'</span>, LIBXML_NOCDATA)), <span class="keyword">true</span>);		</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;values;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * 格式化参数格式化成url参数</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ToUrlParams</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$buff</span> = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$this</span>-&gt;values <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="variable">$k</span> != <span class="string">"sign"</span> &amp;&amp; <span class="variable">$v</span> != <span class="string">""</span> &amp;&amp; !is_array(<span class="variable">$v</span>))&#123;</span><br><span class="line">        <span class="variable">$buff</span> .= <span class="variable">$k</span> . <span class="string">"="</span> . <span class="variable">$v</span> . <span class="string">"&amp;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$buff</span> = trim(<span class="variable">$buff</span>, <span class="string">"&amp;"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$buff</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * 生成签名</span><br><span class="line">   * <span class="doctag">@return</span> 签名，本函数不覆盖sign成员变量，如要设置签名需要调用SetSign方法赋值</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">MakeSign</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="comment">//签名步骤一：按字典序排序参数</span></span><br><span class="line">    ksort(<span class="variable">$this</span>-&gt;values);</span><br><span class="line">    <span class="variable">$string</span> = <span class="variable">$this</span>-&gt;ToUrlParams();</span><br><span class="line">    <span class="comment">//签名步骤二：在string后加入KEY</span></span><br><span class="line">    <span class="variable">$string</span> = <span class="variable">$string</span> . <span class="string">"&amp;key="</span>.WxPayConfig::KEY;</span><br><span class="line">    <span class="comment">//签名步骤三：MD5加密</span></span><br><span class="line">    <span class="variable">$string</span> = md5(<span class="variable">$string</span>);</span><br><span class="line">    <span class="comment">//签名步骤四：所有字符转为大写</span></span><br><span class="line">    <span class="variable">$result</span> = strtoupper(<span class="variable">$string</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * 获取设置的值</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">GetValues</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;values;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>WxPayDataBase是WxPay.Data.php文件中其他类的基类，定义了数据类的基本行为，包括：计算/设置/获取签名、输出XML格式的参数、从XML读取数据对象等。<br>变量$values存储各个接口参数，$values输出为XML时，对于非数字类型的变量使用CDATA进行标记，防止XML解析器进行解析，同理将XML对象转换为$value数组时，使用LIBXML_NOCDATA的方式：<code>$this-&gt;values = json_decode(json_encode(simplexml_load_string($xml, &#39;SimpleXMLElement&#39;, LIBXML_NOCDATA)), true);</code><br><strong>微信支付签名生成规则：</strong><br>微信支付的签名生成由四个步骤组成：<br>◆ 将接口参数名按照字典顺序排序并格式化为URL参数<br>◆ 末尾拼接key<br>◆ MD5加密<br>◆ 所有字符转为大写</p>
<h4 id="WxPayResults类"><a href="#WxPayResults类" class="headerlink" title="WxPayResults类"></a>WxPayResults类</h4><p><em><font color="green">位置：lib/WxPay.Data.php</font></em><br><code>WxPayResults</code>类继承自数据对象基础类<code>WxPayDataBase</code>，主要用来处理接口调用结果，方法<code>Init</code>和<code>InitFromArray</code>均是初始化一个WxPayResults对象，Init方法使用接口调用返回的XML数据进行初始化并强制验证签名，返回数组；InitFromArray方法使用数组初始化WxPayResults对象的values，返回实例化后的WxPayResults对象。</p>
<h4 id="WxPayNotifyReply类"><a href="#WxPayNotifyReply类" class="headerlink" title="WxPayNotifyReply类"></a>WxPayNotifyReply类</h4><p><em><font color="green">位置：lib/WxPay.Data.php</font></em><br><code>WxPayNotifyReply</code>类同样继承自数据对象基础类<code>WxPayDataBase</code>，用来处理授权回调，主要获取/设置return_code和return_msg。<br>WxPay.Data.php文件中定义的剩余其他类均是对各相应业务接口参数的合法性检测，包括获取参数、设置参数以及检测参数是否存在（例如：SetAppid、GetAppid、IsAppidSet）。</p>
<h4 id="WxPayApi类"><a href="#WxPayApi类" class="headerlink" title="WxPayApi类"></a>WxPayApi类</h4><p><em><font color="green">位置：lib/WxPay.Api.php</font></em><br>WxPayApi包含了所有微信支付API的封装，各个API实现的模式均为：<br>◆ 设置/校验接口参数<br>◆ 生成签名<br>◆ 接口参数转换为XML字符串并记录请求开始时间<br>◆ POST方式提交XML至接口URL<br>◆ 返回的XML结果转换为数组<br>◆ 记录请求结束时间并将请求结果上报微信<br>以<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1" target="_blank" rel="external">统一下单</a>API为例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * </span><br><span class="line">   * 统一下单，WxPayUnifiedOrder中out_trade_no、body、total_fee、trade_type必填</span><br><span class="line">   * appid、mchid、spbill_create_ip、nonce_str不需要填入</span><br><span class="line">   * <span class="doctag">@param</span> WxPayUnifiedOrder $inputObj</span><br><span class="line">   * <span class="doctag">@param</span> int $timeOut</span><br><span class="line">   * <span class="doctag">@throws</span> WxPayException</span><br><span class="line">   * <span class="doctag">@return</span> 成功时返回，其他抛异常</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unifiedOrder</span><span class="params">(<span class="variable">$inputObj</span>, <span class="variable">$timeOut</span> = <span class="number">6</span>)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="string">"https://api.mch.weixin.qq.com/pay/unifiedorder"</span>;</span><br><span class="line">    <span class="comment">//检测必填参数</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$inputObj</span>-&gt;IsOut_trade_noSet()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"缺少统一支付接口必填参数out_trade_no！"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="variable">$inputObj</span>-&gt;IsBodySet())&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"缺少统一支付接口必填参数body！"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="variable">$inputObj</span>-&gt;IsTotal_feeSet()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"缺少统一支付接口必填参数total_fee！"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="variable">$inputObj</span>-&gt;IsTrade_typeSet()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"缺少统一支付接口必填参数trade_type！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//关联参数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$inputObj</span>-&gt;GetTrade_type() == <span class="string">"JSAPI"</span> &amp;&amp; !<span class="variable">$inputObj</span>-&gt;IsOpenidSet())&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"统一支付接口中，缺少必填参数openid！trade_type为JSAPI时，openid为必填参数！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$inputObj</span>-&gt;GetTrade_type() == <span class="string">"NATIVE"</span> &amp;&amp; !<span class="variable">$inputObj</span>-&gt;IsProduct_idSet())&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"统一支付接口中，缺少必填参数product_id！trade_type为JSAPI时，product_id为必填参数！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//异步通知url未设置，则使用配置文件中的url</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$inputObj</span>-&gt;IsNotify_urlSet())&#123;</span><br><span class="line">      <span class="comment">//坑!WxPayConfig中没有该配置项</span></span><br><span class="line">      <span class="variable">$inputObj</span>-&gt;SetNotify_url(WxPayConfig::NOTIFY_URL);<span class="comment">//异步通知url</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$inputObj</span>-&gt;SetAppid(WxPayConfig::APPID);<span class="comment">//公众账号ID</span></span><br><span class="line">    <span class="variable">$inputObj</span>-&gt;SetMch_id(WxPayConfig::MCHID);<span class="comment">//商户号</span></span><br><span class="line">    <span class="variable">$inputObj</span>-&gt;SetSpbill_create_ip(<span class="variable">$_SERVER</span>[<span class="string">'REMOTE_ADDR'</span>]);<span class="comment">//终端ip	  </span></span><br><span class="line">    <span class="comment">//$inputObj-&gt;SetSpbill_create_ip("1.1.1.1");  	    </span></span><br><span class="line">    <span class="variable">$inputObj</span>-&gt;SetNonce_str(<span class="keyword">self</span>::getNonceStr());<span class="comment">//随机字符串</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//签名</span></span><br><span class="line">    <span class="variable">$inputObj</span>-&gt;SetSign();</span><br><span class="line">    <span class="variable">$xml</span> = <span class="variable">$inputObj</span>-&gt;ToXml();</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$startTimeStamp</span> = <span class="keyword">self</span>::getMillisecond();<span class="comment">//请求开始时间</span></span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">self</span>::postXmlCurl(<span class="variable">$xml</span>, <span class="variable">$url</span>, <span class="keyword">false</span>, <span class="variable">$timeOut</span>);</span><br><span class="line">    <span class="variable">$result</span> = WxPayResults::Init(<span class="variable">$response</span>);</span><br><span class="line">    <span class="keyword">self</span>::reportCostTime(<span class="variable">$url</span>, <span class="variable">$startTimeStamp</span>, <span class="variable">$result</span>);<span class="comment">//上报请求花费时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>扫码支付、公共号支付以及APP支付都会使用统一下单API，即它是这三种支付模式的公共接口。<br>统一下单API接收2个参数：$inputObj和$timeOut，$inputObj是WxPayUnifiedOrder类的对象，WxPayUnifiedOrder类存在于文件lib/WxPay.Data.php中，用于验证统一下单接口参数的合法性；$timeOut用来设置post请求的超时时间。<br>统一下单接口官方WIKI文档中给出的必填参数有appid、mch_id、nonce_str、sign、body、out_trade_no、total_fee、spbill_create_ip、notify_url、trade_type；对于扫码支付模式还必须传参数product_id；对于公共号支付（JSAPI）openid参数也为必填项，所以API接口中首先对需要用户主动传递的参数body、out_trade_no、total_fee、trade_type进行存在性校验；对关联参数product_id和openid需要根据支付模式的不同进行关联验证。<br>异步通知回调地址参数notify_url，<font color="red">此处官方API中存在错误：</font><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="variable">$inputObj</span>-&gt;IsNotify_urlSet())&#123;</span><br><span class="line">            <span class="comment">//坑!WxPayConfig中没有该配置项</span></span><br><span class="line">            <span class="variable">$inputObj</span>-&gt;SetNotify_url(WxPayConfig::NOTIFY_URL);<span class="comment">//异步通知url</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为WxPayConfig文件中不存在常量NOTIFY_URL，所以可以自行在WxPayConfig文件中添加NOTIFY_URL常量或者在每次调用统一下单接口时全部主动传递异步回调地址。<br><strong>生成随机字符串：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * </span><br><span class="line">   * 产生随机字符串，不长于32位</span><br><span class="line">   * <span class="doctag">@param</span> int $length</span><br><span class="line">   * <span class="doctag">@return</span> 产生的随机字符串</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getNonceStr</span><span class="params">(<span class="variable">$length</span> = <span class="number">32</span>)</span> </span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$chars</span> = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789"</span>;  </span><br><span class="line">    <span class="variable">$str</span> =<span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )  &#123;  </span><br><span class="line">      <span class="variable">$str</span> .= substr(<span class="variable">$chars</span>, mt_rand(<span class="number">0</span>, strlen(<span class="variable">$chars</span>)-<span class="number">1</span>), <span class="number">1</span>);  </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>原理也比较简单，首先列举所有小写字母和数字，然后使用mt_rand方法从字符串中随机得到一个开始位置并截取一个字符，根据所需要产生的随机字符串长度进行拼接。<br>设置完接口所需的各个参数后，最后调用生成签名方法，<font color="red">需要注意的是微信支付生成签名时，字段名称区分大小写</font>。<br>所有接口数据最终会通过<code>postXmlCurl</code>方法发送到微信服务器:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 以post方式提交xml到对应的接口url</span><br><span class="line"> * <span class="doctag">@param</span> string $xml  需要post的xml数据</span><br><span class="line"> * <span class="doctag">@param</span> string $url  url</span><br><span class="line"> * <span class="doctag">@param</span> bool $useCert 是否需要证书，默认不需要</span><br><span class="line"> * <span class="doctag">@param</span> int $second   url执行超时时间，默认30s</span><br><span class="line"> * <span class="doctag">@throws</span> WxPayException</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">postXmlCurl</span><span class="params">(<span class="variable">$xml</span>, <span class="variable">$url</span>, <span class="variable">$useCert</span> = false, <span class="variable">$second</span> = <span class="number">30</span>)</span></span><br><span class="line"></span>&#123;		</span><br><span class="line">  <span class="variable">$ch</span> = curl_init();</span><br><span class="line">  <span class="comment">//设置超时</span></span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="variable">$second</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//如果有配置代理这里就设置代理</span></span><br><span class="line">  <span class="keyword">if</span>(WxPayConfig::CURL_PROXY_HOST != <span class="string">"0.0.0.0"</span> </span><br><span class="line">    &amp;&amp; WxPayConfig::CURL_PROXY_PORT != <span class="number">0</span>)&#123;</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_PROXY, WxPayConfig::CURL_PROXY_HOST);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_PROXYPORT, WxPayConfig::CURL_PROXY_PORT);</span><br><span class="line">  &#125;</span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>,CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSL_VERIFYPEER,<span class="keyword">FALSE</span>);</span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSL_VERIFYHOST,<span class="keyword">FALSE</span>);</span><br><span class="line">  <span class="comment">//设置header</span></span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="keyword">FALSE</span>);</span><br><span class="line">  <span class="comment">//要求结果为字符串且输出到屏幕上</span></span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="keyword">TRUE</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$useCert</span> == <span class="keyword">true</span>)&#123;</span><br><span class="line">    <span class="comment">//设置证书</span></span><br><span class="line">    <span class="comment">//使用证书：cert 与 key 分别属于两个.pem文件</span></span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSLCERTTYPE,<span class="string">'PEM'</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSLCERT, WxPayConfig::SSLCERT_PATH);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSLKEYTYPE,<span class="string">'PEM'</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSLKEY, WxPayConfig::SSLKEY_PATH);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//post提交方式</span></span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>, CURLOPT_POST, <span class="keyword">TRUE</span>);</span><br><span class="line">  curl_setopt(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="variable">$xml</span>);</span><br><span class="line">  <span class="comment">//运行curl</span></span><br><span class="line">  <span class="variable">$data</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">  <span class="comment">//返回结果</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$data</span>)&#123;</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="variable">$error</span> = curl_errno(<span class="variable">$ch</span>);</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> WxPayException(<span class="string">"curl出错，错误码:$error"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所有接口参数以XML格式发送给微信服务器，微信服务器同样以XML格式返回接口调用结果。<code>$result = WxPayResults::Init($response);</code>将微信返回的XML结果转换为数组形式并返回。</p>
<h4 id="WxPayNotify类"><a href="#WxPayNotify类" class="headerlink" title="WxPayNotify类"></a>WxPayNotify类</h4><p><em><font color="green">位置：lib/WxPay.Notify.php</font></em><br>WxPayNotify类是进行业务回调处理的基础类，它继承自WxPayNotifyReply类。WxPayNotify类包含的方法有Handle、NotifyProcess、NotifyCallBack以及ReplyNotify。其中Handle方法是回调处理的入口函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * </span><br><span class="line"> * 回调入口</span><br><span class="line"> * <span class="doctag">@param</span> bool $needSign  是否需要签名输出</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Handle</span><span class="params">(<span class="variable">$needSign</span> = true)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="variable">$msg</span> = <span class="string">"OK"</span>;</span><br><span class="line">  <span class="comment">//当返回false的时候，表示notify中调用NotifyCallBack回调失败获取签名校验失败，此时直接回复失败</span></span><br><span class="line">  <span class="variable">$result</span> = WxpayApi::notify(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="string">'NotifyCallBack'</span>), <span class="variable">$msg</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$result</span> == <span class="keyword">false</span>)&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;SetReturn_code(<span class="string">"FAIL"</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;SetReturn_msg(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;ReplyNotify(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//该分支在成功回调到NotifyCallBack方法，处理完成之后流程</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;SetReturn_code(<span class="string">"SUCCESS"</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;SetReturn_msg(<span class="string">"OK"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$this</span>-&gt;ReplyNotify(<span class="variable">$needSign</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>WxpayApi类的notify方法为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * </span><br><span class="line">   * 支付结果通用通知</span><br><span class="line">   * <span class="doctag">@param</span> function $callback</span><br><span class="line">   * 直接回调函数使用方法: notify(you_function);</span><br><span class="line">   * 回调类成员函数方法:notify(array($this, you_function));</span><br><span class="line">   * $callback  原型为：function function_name($data)&#123;&#125;</span><br><span class="line">   */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">(<span class="variable">$callback</span>, &amp;<span class="variable">$msg</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="comment">//获取通知的数据</span></span><br><span class="line">  <span class="variable">$xml</span> = <span class="variable">$GLOBALS</span>[<span class="string">'HTTP_RAW_POST_DATA'</span>];</span><br><span class="line">  <span class="comment">//如果返回成功则验证签名</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$result</span> = WxPayResults::Init(<span class="variable">$xml</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (WxPayException <span class="variable">$e</span>)&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$e</span>-&gt;errorMessage();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> call_user_func(<span class="variable">$callback</span>, <span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先分析方法<code>notify</code>：<code>$GLOBALS[&#39;HTTP_RAW_POST_DATA&#39;];</code>获取到微信服务器返回的XML结果，通过WxPayResults的Init方法得到返回结果数组，以参数的方式传递给call_user_func方法。如果使用类方法作为call_user_func的参数，需要使用：array($className, $functionName)的方式传递参数，因此<code>$result = WxpayApi::notify(array($this, &#39;NotifyCallBack&#39;), $msg);</code>的含义为：将微信返回的结果数组作为参数传递给函数NotifyCallBack，$result为NotifyCallBack方法的返回结果。<br>在NotifyCallBack方法中调用NotifyProcess，该方法需要用户在继承WxPayNotify类时进行重写（后续微信支付实现时需要重写该方法）。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * </span><br><span class="line"> * 回复通知</span><br><span class="line"> * <span class="doctag">@param</span> bool $needSign 是否需要签名输出</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">ReplyNotify</span><span class="params">(<span class="variable">$needSign</span> = true)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="comment">//如果需要签名</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$needSign</span> == <span class="keyword">true</span> &amp;&amp; </span><br><span class="line">   <span class="comment">//$this-&gt;GetReturn_code($return_code) == "SUCCESS")</span></span><br><span class="line">        <span class="comment">//又现一处SDK错误，$return_code多余</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;GetReturn_code() == <span class="string">"SUCCESS"</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;SetSign();</span><br><span class="line">  &#125;</span><br><span class="line">  WxpayApi::replyNotify(<span class="variable">$this</span>-&gt;ToXml());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>ReplyNotify</code>直接输出回调处理完成后的XML数据。因为是回调系统，直接输出XML后，微信后台可以获取到该输出内容，所以不需要开发者主动将结果发送给微信后台。<br>此处官方SDK又出现一处错误：<code>GetReturn_code</code>方法不需要传递参数，应该把$return_code删除。</p>
<p>微信支付相关的准备工作已介绍完毕，在下一节<a href="http://yurixu.com/blog/2016/07/15/%E6%BC%AB%E8%B0%88%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E6%89%AB%E7%A0%81%E6%94%AF%E4%BB%98/">漫谈微信支付-扫码支付</a>将会介绍扫码支付的实现过程。<br>转载请注明出处：<a href="http://yurixu.com/blog/2016/06/28/%E6%BC%AB%E8%B0%88%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98/">http://yurixu.com/blog/2016/06/28/漫谈微信支付/</a></p>

      
    </div>
    <footer class="article-footer">
      <!-- modify by yurixu 2016/1/1 replace Share -->
      <a data-url="http://yurixu.com/blog/2016/06/28/漫谈微信支付/" data-id="cjhrqm47v0022hkrd3q9ce0uv" class="article-share-link bdsharebuttonbox" data-cmd="more">分享</a>
      <script>
      window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
      </script>
   

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/支付/">支付</a></li></ul>

      <!--添加单篇文章阅读量统计-->
      <span id="busuanzi_container_page_pv">
        本文总阅读量<span id="busuanzi_value_page_pv"></span>次
      </span>
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2016/07/15/漫谈微信支付-扫码支付/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          漫谈微信支付-扫码支付
        
      </div>
    </a>
  
  
    <a href="/blog/2016/05/10/Windows开启cUrl模块（Call-to-undefined-function-curl-init-）/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Windows开启cUrl模块（Call to undefined function curl_init()）</div>
    </a>
  
</nav>

  
</article>


  <!-- 向百度自动推送-->
  <script>
  (function(){
      var bp = document.createElement('script');
      bp.src = '//push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();
  </script></section>
        
      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Read/">Read</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Excel/">Excel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Read/">Read</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sublime/">Sublime</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/issue/">issue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客/">博客</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/存储过程/">存储过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/总结/">总结</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/支付/">支付</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件/">文件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/阅读/">阅读</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/FFmpeg/" style="font-size: 10px;">FFmpeg</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/MySQL/" style="font-size: 11.67px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/Python/" style="font-size: 13.33px;">Python</a> <a href="/tags/Read/" style="font-size: 16.67px;">Read</a> <a href="/tags/Sublime/" style="font-size: 11.67px;">Sublime</a> <a href="/tags/issue/" style="font-size: 10px;">issue</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/存储过程/" style="font-size: 10px;">存储过程</a> <a href="/tags/总结/" style="font-size: 10px;">总结</a> <a href="/tags/支付/" style="font-size: 18.33px;">支付</a> <a href="/tags/文件/" style="font-size: 10px;">文件</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/阅读/" style="font-size: 11.67px;">阅读</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/05/28/MySql主从同步简述/">MySQL主从复制简述</a>
          </li>
        
          <li>
            <a href="/blog/2018/05/22/PHP APCU简述/">PHP APCu简述</a>
          </li>
        
          <li>
            <a href="/blog/2016/11/10/统计数据表各列非空值的数量/">统计数据表各列非空值的数量</a>
          </li>
        
          <li>
            <a href="/blog/2016/09/06/Postman-接口调试工具使用简介/">Postman接口调试工具使用简介</a>
          </li>
        
          <li>
            <a href="/blog/2016/09/02/FFmpeg音视频转换/">FFmpeg音视频转换</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
    
  <!-- add by yurixu 2016/1/3 add bottom -->
  <div class="outer">
    <div id="footer-info" class="inner" style="text-align:center;">
	  <table width="100%" border="0">
        <tr>
          <td style="text-align:left">          
            Copyright &copy; 2018 Yurixu &nbsp; &nbsp;
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><br>
	        <span id="busuanzi_container_site_uv">Total visit <span id="busuanzi_value_site_uv"></span> times</span> &nbsp; &nbsp; &nbsp; &nbsp;
	        <span id="busuanzi_container_site_pv">Total views <span id="busuanzi_value_site_pv"></span> times</span> 
		  </td>
		  <td style="text-align:right">
		    <div style="font-family: FontAwesome;font-size: 20px;">
		    <a href="http://weibo.com/xywEliot" title="微博" target="_blank">&#61834;</a>&nbsp;		
			<a href="http://user.qzone.qq.com/864909480" title="QQ空间" target="_blank">&#61910;</a>&nbsp;
		    <a href="https://github.com/xuyuri" title="GitHub" target="_blank">&#61595;</a>&nbsp;
		    <a href="http://www.linkedin.com/in/yurixu" title="LinkedIn" target="_blank">&#61665;</a>&nbsp;			    	
			</div><br>
		    <a href="/sitemap.xml">网站地图</a>&nbsp; &nbsp;			
			<a href="mailto:xywbupt@126.com" target="_blank">联系博主</a>&nbsp; &nbsp;	
			<a href="http://tongji.baidu.com/web/18697832">站长统计</a>			
		  </td>
        </tr>
      </table>
    </div>
</div>
</footer>
<!-- add by yurixu 2016/1/1 add website counter -->
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/Read/" class="mobile-nav-link">Reading</a>
  
    <a href="https://github.com/xuyuri" class="mobile-nav-link">GitHub</a>
  
    <a href="/atom.xml" class="mobile-nav-link">RSS</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    
< !-- add by yurixu 替换Google的jquery并且添加判断逻辑 -->
<script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
if (typeof jQuery == 'undefined') {
  document.write(unescape("%3Cscript src='/js/jquery-2.0.3.min.js' type='text/javascript'%3E%3C/script%3E"));
}
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- add by yurixu 2016/1/8 添加swiftype搜索代码 -->
<!-- 
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','Fa9mKyRrtZcNX19oWoxv','2.0.0');
</script>
-->

  </div>
</body>
</html>