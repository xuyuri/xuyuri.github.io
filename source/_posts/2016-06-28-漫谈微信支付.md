title: 漫谈微信支付
toc: false
date: 2016-06-28 13:54:15
categories: PHP
tags: [PHP, 支付] 
description: 漫谈微信支付
---

![](http://7xrc03.com1.z0.glb.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpeg)
本文对微信支付的应用场景、支付模式、准备工作等进行简要概括。
<!--more-->

## 概述
微信支付目前在生活中应用的越来越广泛，目前微信支付的应用模式有刷卡支付、公共号支付、扫码支付以及APP支付，每种支付模式都有不同的应用场景与之对应。

## 支付模式
直接引用微信官方文档中对微信四种支付模式的说明：

### 刷卡支付
刷卡支付是用户展示微信钱包内的“刷卡条码/二维码”给商户系统扫描后直接完成支付的模式。主要应用线下面对面收银的场景。

### 扫码支付
扫码支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。

### 公共号支付
公众号支付是用户在微信中打开商户的H5页面，商户在H5页面通过调用微信支付提供的JSAPI接口调起微信支付模块完成支付。应用场景有：
◆ 用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付
◆ 用户的好友在朋友圈、聊天窗口等分享商家页面连接，用户点击链接打开商家页面，完成支付
◆ 将商户页面转换成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付。

### APP支付
APP支付又称移动端支付，是商户通过在移动端应用APP中集成开放SDK调起微信支付模块完成支付的模式。

本系列文章主要介绍后三种支付模式，分别介绍三种不同支付模式的实现以及汇总实现过程中可能遇到问题。

## 前期准备
使用微信支付前需要进行接入，商户根据实际需求可以申请接入以上介绍的四种不同支付模式，其中APP支付模式需要在[微信开放平台](https://open.weixin.qq.com/)申请，扫码支付和公共号支付需要在[微信公共平台](http://mp.weixin.qq.com)申请。申请成功后，微信会将微信支付开发相关的账号信息发送至申请邮箱中，包括：
![前期准备](/img/微信支付系列/前期准备.png)

|		邮件中参数	 |        API参数名  	  |        说明  	  |
| :---------		  |    :----------   |    :-------   |
| 	APPID	 | appid | 微信公众账号或开放平台APP的唯一标识 |
| 商户号   | mch_id | 微信支付分配的商户收款账号 |
| API密钥   | key | 交易过程生成签名的密钥，仅保留在商户系统和微信支付后台，不会在网络中传播 |
| Appsecret   | secret | APPID对应的接口密码，用于获取接口调用凭证access_token时使用 |

得到这些参数后就可以进行微信支付的开发了。

## 微信支付PHP-SDK
微信提供了JAVA、.NET/C#、PHP三种类型的SDK，PHP版本的SDK目录结构如下所示：
```
SDK目录结构
|-- cert
|   |-- apiclient_cert.pem
|   `-- apiclient_key.pem
|-- index.php
|-- lib
|   |-- WxPay.Api.php
|   |-- WxPay.Config.php
|   |-- WxPay.Data.php
|   |-- WxPay.Exception.php
|   `-- WxPay.Notify.php
|-- logs
`-- example
    |-- WxPay.JsApiPay.php
    |-- WxPay.MicroPay.php
    |-- WxPay.NativePay.php
	|-- download.php
	|-- micropay.php
	|-- native.php
	|-- native_notify.php
	|-- notify.php
	|-- orderquery.php
	|-- qrcode.php
	|-- refund.php
	|-- refundquery.php
	|-- jsapi.php
    |-- log.php
    `-- phpqrcode
```
各个目录以及文件的说明如下：
◆ **cert：证书的存放路径**
商户证书是微信提供的二进制文件，商户系统发起与微信支付后台服务器通信请求的时候，作为微信支付后台识别商户真实身份的凭据。商户证书在涉及资金回滚的微信支付接口中使用，包括：申请退款、撤销订单接口。
微信提供了四种商户证书：pkcs12格式、证书pem格式、证书密钥pem格式、CA证书，登录[微信商户平台](pay.weixin.qq.com)-->账户设置-->API安全-->证书下载，可以进行证书下载。PHP开发只需要用到证书pem格式、证书密钥pem格式，即apiclient_cert.pem和apiclient_key.pem。
◆ **index.php：SDK的入口文件**
◆ **lib：微信支付API库**
lib目录下的文件是微信支付开发用到的主要文件，提供了对微信支付的各种接口的封装。其中：
`WxPay.Config.php`：封装了WxPayConfig类，提供了微信支付所需的基本配置信息包括：APPID、MCHID、KEY、APPSECRET、证书路径、代理设置、微信支付接口上报配置。
`WxPay.Data.php`：接口输入参数的封装，包括：WxPayDataBase（数据对象基础类）、WxPayResults（接口调用结果类）、WxPayNotifyReply（微信支付回调基础类）、WxPayUnifiedOrder（微信支付统一下单类）、WxPayOrderQuery（查询订单类）、WxPayCloseOrder（关闭订单类）、WxPayRefund（申请退款类）、WxPayRefundQuery（查询退款类）、WxPayDownloadBill（下载对账单类）、WxPayReport（接口测试上报类）、WxPayShortUrl（短连接转换类）、WxPayMicroPay（刷卡支付类）、WxPayReverse（撤销订单类）、WxPayJsApiPay（公共号支付类）以及WxPayBizPayUrl（扫码支付模式一）
◆ **logs：日志文件**
◆ **example：样例程序**




---- 完结 ----