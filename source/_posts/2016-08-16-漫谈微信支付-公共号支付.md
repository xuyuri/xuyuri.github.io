title: 漫谈微信支付-公共号支付
toc: false
date: 2016-08-16 21:22:48
categories: PHP
tags: [PHP, 支付]
description: 漫谈微信支付-公共号支付
---

![](http://7xrc03.com1.z0.glb.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpeg)
本文对微信公共号支付的实现过程进行详细介绍。

<!--more-->

## 概述
公共号支付主要应用于微信内H5页面上发起的微信支付流程，它相对于扫码支付和APP要复杂一些，而且在实际开发过程中遇到的问题相对较多。

## 实现过程
公共号支付与APP支付类似，都需要调起统一下单接口获得prepay_id，根据prepay_id等参数调起微信发起支付流程，最后微信后台将支付结果异步回调给商户后台。
◆ **统一下单**
公共号统一下单接口需要传递openid参数，微信公共平台对于openid的解释如下：
*在关注者与公众号产生消息交互后，公众号可获得关注者的OpenID（加密后的微信号，每个用户对每个公众号的OpenID是唯一的。对于不同公众号，同一用户的openid不同）。
公众号可根据以下接口来获取用户的openid，如需获取用户的昵称、头像、性别、所在城市、语言和关注时间，则需要用户授权。
参考信息：http://mp.weixin.qq.com/wiki/17/c0f37d5704f0b64713d5d2c37b468d75.html
开发者如果需要将同一个用户在不同公众号下的openid统一为一个id来记录，可以参考以下接口：
参考信息：http://mp.weixin.qq.com/wiki/14/bb5031008f1494a59c6f71fa0f319c66.html*
即openid其实是每个用户在不同公共号内的唯一标示，获取openid需要先经过用户同意授权，获取code，再通过code获取openid。
◆ **获取用户授权**
微信提供了两种授权方式：snsapi_base和snsapi_userinfo。
snsapi_base：不弹出授权页面，直接跳转，只能获取用户openid；
snsapi_userinfo：弹出授权页面，可通过openid拿到昵称、性别、所在地。并且，即使在未关注的情况下，只要用户授权，也能获取其信息。
想要获取code，需要构造如下地址：
`https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect`
其中SCOPE参数为snsapi_base或snsapi_userinfo，REDIRECT_URI为获取用户授权后跳转的地址。
此处需要在微信公共平台配置授权回调页面域名:微信公共平台->接口权限->网页授权获取用户基本信息，点击“修改”，在弹出的页面中填写授权回调页面域名，REDIRECT_URI所在的域名要与填写的回调页面域名相同，否则在进行用户授权时会提示redirect_uri错误。

## 常见问题