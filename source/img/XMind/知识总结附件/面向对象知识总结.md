# 面向对象知识总结

## 面向对象理解
### 概念
面向对象是一种程序设计理念，与程序语言无关。它将对象作为程序的基本单元，将属性和方法封装其中以提高软件的重用性、灵活性和扩展性。

### 类与对象
 **关系**：类是对象的抽象组织，对象是类的具体化存在；
 **内部存储**：类是属性和方法的集合，对象是属性的集合。同一个类创建的不同对象，拥有各自不同的属性，但是共享了类代码空间中方法区的代码。
``` php
typedef union _zvalue_value {
    long lval;
    double dval;
    struct {
        char *val;
        int len;
    } str;
    HashTable *ht;
    zend_object_value obj;
} zvalue_value;
```
`_zvalue_value`是PHP源码中对变量的定义，PHP是用C语言开发，union在C中表示结构体，它有如下特点：
```
1. union中可以定义多个成员，union的大小由最大的成员的大小决定；
2. union成员共享同一块大小的内存，一次只能使用其中的一个成员；
3. 对某一个成员赋值，会覆盖其他成员的值。
```
了解C语言中的union特点后即知道zvalue_value一次只能表示一种类型的变量，它可以表示整型、浮点型、字符串、数组（HashTable）和对象（zend_object_value），PHP中还有resource类型，是一个整型值，从而存储在lval中；bool类型用0和1表示，也存储在lval中；NULL类型没有任何意义，不需要用字段表示，因此直接使用C语言中的null表示。
PHP中的对象使用结构体`zend_object_value`存储：
```php
typedef struct _zend_object_value {
    zend_object_handle handle;   //  unsigned int类型，EG(objects_store).object_buckets的索引    
    zend_object_handlers *handlers;
} zend_object_value;
```
PHP内核中将所有对象保存到一个对象列表容器object_buckets中，因此handle字段就是在这个列表容器中的索引；字段handlers的类型是zend_object_handlers，这是一个包含了多个指针函数的结构体，这些指针函数包括对对象属性的操作，对对象方法的操作，克隆等。 此字段会在对象创建的时候初始化。
当我们需要在PHP中存储对象的时候， PHP内核会根据handle索引从对象列表object_buckets中获取相对应的对象。而获取的对象有其独立的结构：
```php
typedef struct _zend_object {
    zend_class_entry *ce;
    HashTable *properties;
    HashTable *guards; /* protects from __get/__set ... recursion */
} zend_object;
```
ce是存储该对象的类结构，在对象初始化时保存了类的入口；properties是一个HashTable，用来存放对象的属性；guards用来阻止递归调用。

[1] [PHP变量在内存中的表示](http://gywbd.github.io/posts/2015/4/php-variable-in-memory.html)
[2] [PHP内核探索：对象](http://www.nowamagic.net/librarys/veda/detail/1521)